{% extends "base.html" %}

{% block title %}
  <title>Task manager - {{ task.name }}</title>
{% endblock %}

{% block content %}
  <a href="{% url 'task_manager:project-detail' pk=task.project.id %}">{{ task.project }}</a>

  <h1>
    {% if task.is_completed %}
      <s class="text-secondary">{{ task.name }}</s>
    {% else %}
      {{ task.name }}
    {% endif %}

    {% if task.is_completed %}
      {% if user_can_activate_task %}
        {% if task.author == user %}
          <a href="{% url 'task_manager:task-status-toggle' pk=task.id new_status="new" %}" class="btn btn-outline-warning">
        {% else %}
          <a href="{% url 'task_manager:task-status-toggle' pk=task.id new_status="progress" %}" class="btn btn-outline-warning">
        {% endif %}
          Re-activate task
        </a>
      {% endif %}

    {% else %}
      {% if task.author == user %}
        <a href="{% url 'task_manager:task-update' pk=task.id %}?next={% url 'task_manager:task-detail' pk=task.id %}" class="btn btn-outline-primary">
          Change
        </a>
        <a href="{% url 'task_manager:task-status-toggle' pk=task.id new_status="canceled" %}" class="btn btn-outline-danger">
          Cancel task
        </a>
      {% endif %}

      {% if task.author == user or task.responsible == user %}
        <a href="{% url 'task_manager:task-status-toggle' pk=task.id new_status="completed" %}" class="btn btn-outline-success">
          Complete task
        </a>
      {% endif %}
    {% endif %}
  </h1>

  <p>
    <a href="{% url 'task_manager:worker-detail' pk=task.author.id %}" class="text-secondary">
      {{ task.author }}
    </a> →
    <a href="{% url 'task_manager:worker-detail' pk=task.responsible.id %}" class="text-secondary">
      {{ task.responsible }}
    </a>
  </p>

  <div class="text-secondary">
    {{ task.created_time|date }}  → {{ task.deadline|date }} {{ task.deadline|time }}
  </div>

  {% if user == task.author or user == task.responsible %}
    {% if task.is_completed == False %}
      <form action="" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="submit" value="Change status" class="btn btn-primary">
      </form>
    {% endif %}
  {% else %}
    <p>Status: {{ task.get_status_display }}</p>
  {% endif %}

  <h2>Followers</h2>

  {% regroup followers by position as regrouped_worker_list %}

  <ul>
    {% for position in regrouped_worker_list %}
      <li>
        {{ position.grouper }}
        <ul>
          {% for worker in position.list %}
            <li>
              <a href="{% url 'task_manager:worker-detail' pk=worker.id %}">
                {{ worker.first_name }} {{ worker.last_name }}
              </a>
              {% if worker == task.author %}
                (<u>Author</u>)
              {% endif %}
              {% if worker == task.responsible %}
                (<u>Responsible</u>)
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </li>
    {% endfor %}
  </ul>

{% endblock %}
